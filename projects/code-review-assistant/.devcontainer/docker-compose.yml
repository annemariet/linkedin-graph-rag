version: '3.8'

services:
  # Code Review Assistant development container
  app:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ..:/workspace:cached
      - vscode-extensions:/root/.vscode-server/extensions
      - vscode-extensions-insiders:/root/.vscode-server-insiders/extensions
    command: sleep infinity
    networks:
      - code-review-network
    environment:
      - DATABASE_URL=postgresql://codereviewer:reviewpass@postgres:5432/code_review_db
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "8000:8000"

  # PostgreSQL database for code review assistant
  postgres:
    image: postgres:15-alpine
    restart: unless-stopped
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
    environment:
      POSTGRES_USER: codereviewer
      POSTGRES_PASSWORD: reviewpass
      POSTGRES_DB: code_review_db
    networks:
      - code-review-network
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U codereviewer -d code_review_db"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis cache for code review assistant
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    volumes:
      - redis-data:/data
    networks:
      - code-review-network
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  code-review-network:
    driver: bridge
    name: code-review-assistant-network

volumes:
  postgres-data:
    name: code-review-assistant-postgres-data
  redis-data:
    name: code-review-assistant-redis-data
  vscode-extensions:
    name: code-review-assistant-vscode-extensions
  vscode-extensions-insiders:
    name: code-review-assistant-vscode-extensions-insiders